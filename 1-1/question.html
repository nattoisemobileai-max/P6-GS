<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âπ≥ÂÆâÊòØÁ¶èÔºöÂÆâÂÖ®Ê∏¨Ë©¶ÊåëÊà∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --duo-green: #58cc02;
            --duo-dark-green: #46a302;
            --duo-blue: #1cb0f6;
            --duo-red: #ff4b4b;
            --duo-gray: #afafaf;
            --duo-light-gray: #e5e5e5;
            --text-main: #4b4b4b;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            background-color: #fff;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* È†ÇÈÉ®ÈÄ≤Â∫¶Ê¢ù */
        .nav-bar {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-sizing: border-box;
        }

        .progress-rail {
            flex-grow: 1;
            height: 16px;
            background-color: var(--duo-light-gray);
            border-radius: 10px;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background-color: var(--duo-green);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* ÈÄ≤Â∫¶ËøΩËπ§ */
        .progress-info {
            width: 90%;
            max-width: 600px;
            padding: 0 20px 10px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: var(--duo-gray);
        }

        .completed {
            color: var(--duo-green);
            font-weight: 700;
        }

        .remaining {
            color: var(--duo-blue);
            font-weight: 700;
        }

        /* Â∞èÁØÄÂêçÁ®± */
        .section-name {
            width: 90%;
            max-width: 600px;
            padding: 10px 20px;
            background-color: #f0f9ff;
            color: var(--duo-blue);
            font-weight: 700;
            font-size: 1.1em;
            margin-top: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--duo-blue);
        }

        /* ‰∏ªÈ°åÂÖßÂÆπ */
        .content {
            width: 90%;
            max-width: 600px;
            margin-top: 10px;
            flex-grow: 1;
        }

        .speech-bubble {
            border: 2px solid var(--duo-light-gray);
            border-radius: 15px;
            padding: 20px;
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 30px;
            position: relative;
        }

        .options-list {
            display: grid;
            gap: 12px;
        }

        .option-item {
            border: 2px solid var(--duo-light-gray);
            border-bottom-width: 4px;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: 0.1s;
            user-select: none;
        }

        .option-item:hover { 
            background-color: #f7f7f7; 
            transform: translateY(-1px);
        }
        
        .option-item.active {
            border-color: var(--duo-blue);
            background-color: #ddf4ff;
            color: var(--duo-blue);
            transform: translateY(-1px);
        }

        .option-item.correct {
            border-color: var(--duo-green);
            background-color: #e8ffd8;
            color: var(--text-main);
        }

        .option-item.wrong {
            border-color: var(--duo-red);
            background-color: #ffeaea;
            color: var(--text-main);
        }

        /* Â∫ïÈÉ®Êìç‰ΩúÊ¨Ñ */
        .footer {
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: center;
            border-top: 2px solid var(--duo-light-gray);
            background: #fff;
        }

        .btn-action {
            width: 100%;
            max-width: 600px;
            padding: 16px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 900;
            cursor: pointer;
            border: none;
            background-color: var(--duo-green);
            color: white;
            box-shadow: 0 5px 0 var(--duo-dark-green);
            transition: all 0.2s;
        }

        .btn-action:hover {
            background-color: #4bc000;
        }

        .btn-action:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 var(--duo-dark-green);
        }

        .btn-action:disabled {
            background-color: var(--duo-light-gray);
            color: var(--duo-gray);
            box-shadow: 0 5px 0 #ccc;
            cursor: not-allowed;
        }

        /* ÂèçÈ•ãÊªëÂãïÂ±§ */
        #feedback-tray {
            position: fixed;
            bottom: -350px;
            left: 0;
            width: 100%;
            padding: 30px;
            box-sizing: border-box;
            transition: bottom 0.3s ease;
            z-index: 100;
        }

        .tray-correct { 
            background-color: #d7ffb8; 
            color: #58a700; 
            border-top: 3px solid #58a700;
        }
        
        .tray-wrong { 
            background-color: #ffdfe0; 
            color: #ea2b2b; 
            border-top: 3px solid #ea2b2b;
        }

        .btn-next {
            background-color: currentColor;
            filter: brightness(0.8);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }

        .btn-next:hover {
            filter: brightness(1);
            transform: scale(1.05);
        }

        /* ÊúÄÁµÇÁï´Èù¢ */
        #final-screen { 
            display: none; 
            text-align: center; 
            width: 90%;
            max-width: 600px;
            margin-top: 20px;
            padding: 20px;
        }
        
        /* Á≠îÈ°åÂõûÈ°ß */
        #review-screen {
            display: none;
            width: 90%;
            max-width: 600px;
            margin-top: 20px;
            padding: 20px;
        }
        
        .review-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .review-item {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid var(--duo-light-gray);
            border-radius: 15px;
            background-color: #fff;
        }
        
        .review-question {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-main);
        }
        
        .review-options {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .review-option {
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid var(--duo-light-gray);
            font-size: 1em;
        }
        
        .review-correct-option {
            border-color: var(--duo-green);
            background-color: #e8ffd8;
        }
        
        .review-user-answer {
            border-color: var(--duo-blue);
            background-color: #ddf4ff;
        }
        
        .review-wrong-answer {
            border-color: var(--duo-red);
            background-color: #ffeaea;
        }
        
        .review-result {
            font-weight: 700;
            padding: 8px 15px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .review-result-correct {
            background-color: #e8ffd8;
            color: var(--duo-green);
        }
        
        .review-result-wrong {
            background-color: #ffeaea;
            color: var(--duo-red);
        }
        
        .review-explanation {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 3px solid var(--duo-gray);
            font-size: 0.95em;
        }
        
        .score-display {
            font-size: 3em;
            font-weight: 900;
            color: var(--duo-blue);
            margin: 20px 0;
        }
        
        .question-counter {
            color: var(--duo-gray);
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .next-btn-text {
            font-size: 1em;
            font-weight: 700;
        }
        
        .review-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .review-section-title {
            color: var(--duo-blue);
            font-weight: 700;
            font-size: 1.1em;
            margin: 20px 0 10px;
            padding: 8px 15px;
            background-color: #f0f9ff;
            border-radius: 8px;
        }
        
        /* Â∞èÁØÄË°®Áèæ */
        .section-performance {
            width: 90%;
            max-width: 600px;
            margin: 20px 0;
        }
        
        .performance-card {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 15px;
            background-color: #fff;
            border: 2px solid var(--duo-light-gray);
            position: relative;
        }
        
        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .performance-title {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-main);
        }
        
        .performance-score {
            font-weight: 900;
            font-size: 1.2em;
        }
        
        .performance-bar {
            height: 10px;
            background-color: var(--duo-light-gray);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .performance-fill {
            height: 100%;
            background-color: var(--duo-green);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .performance-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: var(--duo-gray);
        }
        
        .performance-perfect {
            border-color: var(--duo-green);
            background-color: #f8fff0;
            border-width: 3px;
        }
        
        .performance-best {
            border-color: var(--duo-green);
            background-color: #f0fff0;
        }
        
        .performance-worst {
            border-color: var(--duo-red);
            background-color: #fff0f0;
        }
        
        .perfect-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background-color: var(--duo-green);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            box-shadow: 0 3px 0 var(--duo-dark-green);
            z-index: 1;
        }
        
        .best-section-badge {
            background-color: var(--duo-green);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            margin-left: 10px;
        }
        
        .worst-section-badge {
            background-color: var(--duo-red);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            margin-left: 10px;
        }
        
        .section-comparison {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 15px;
        }
        
        .comparison-title {
            font-weight: 700;
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--text-main);
        }
        
        .perfect-score-badge {
            display: inline-block;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 900;
            margin: 10px 0;
            box-shadow: 0 4px 0 #cc8400;
        }
        
        .perfect-sections-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .perfect-section-badge {
            background: linear-gradient(45deg, var(--duo-green), #46a302);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .badge-icon {
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <span style="color:var(--duo-gray); font-size: 24px; cursor: pointer;" onclick="location.reload()">‚úï</span>
        <div class="progress-rail"><div class="progress-fill" id="pb"></div></div>
    </div>

    <div class="progress-info" id="progress-info">
        <div>Â∑≤ÂÆåÊàê: <span id="completed-count" class="completed">0</span></div>
        <div>Ââ©È§ò: <span id="remaining-count" class="remaining">0</span></div>
    </div>

    <div class="section-name" id="section-name"></div>

    <div class="content" id="quiz-ui">
        <div class="question-counter" id="counter">Á¨¨ <span id="current-q">1</span> È°å</div>
        <div class="speech-bubble" id="q-text">ü¶â Ê≠£Âú®ÁÇ∫‰Ω†Ê∫ñÂÇôÈ°åÁõÆ...</div>
        <div class="options-list" id="opt-list"></div>
    </div>

    <div id="final-screen">
        <h1 style="font-size: 4em;">üèÜ</h1>
        <h2 id="final-msg">‰Ω†ÂÆåÊàê‰∫ÜÊâÄÊúâÊåëÊà∞ÔºÅ</h2>
        <div class="score-display" id="final-score"></div>
        
        <!-- ÂÖ®Â∞çÂ∞èÁØÄÂæΩÁ´† -->
        <div id="perfect-sections-container" class="perfect-sections-container"></div>
        
        <!-- Â∞èÁØÄË°®Áèæ -->
        <div id="section-performance-container" style="width: 100%; margin: 30px 0;"></div>
        
        <div style="margin: 30px 0;">
            <button class="btn-action" onclick="showReview()" style="margin-bottom: 15px;">Êü•ÁúãÁ≠îÈ°åË©≥ÊÉÖ</button>
            <button class="btn-action" onclick="location.reload()" style="background-color: var(--duo-blue); box-shadow: 0 5px 0 #0a9cda;">ÈáçÊñ∞ÈñãÂßã</button>
        </div>
    </div>

    <div id="review-screen">
        <div class="review-header">
            <h2>üìä Á≠îÈ°åÂõûÈ°ß</h2>
            <div class="score-display" id="review-score"></div>
        </div>
        
        <div id="review-list"></div>
        
        <div class="review-buttons">
            <button class="btn-action" onclick="showFinalScreen()" style="background-color: var(--duo-gray); box-shadow: 0 5px 0 #999;">ËøîÂõûÁµêÊûú</button>
            <button class="btn-action" onclick="location.reload()">ÈáçÊñ∞ÊåëÊà∞</button>
        </div>
    </div>

    <div class="footer" id="footer-bar">
        <button class="btn-action" id="check-btn" disabled onclick="handleCheck()">Ê™¢Êü•Á≠îÊ°à</button>
    </div>

    <div id="feedback-tray">
        <div style="max-width: 600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 id="tray-title" style="margin:0">ÂæàÂ•ΩÔºÅ</h2>
                <p id="tray-desc" style="margin: 5px 0 0; font-weight: 500;"></p>
            </div>
            <button class="btn-next" onclick="loadNext()">
                <span class="next-btn-text" id="next-btn-text">ÁπºÁ∫å</span>
            </button>
        </div>
    </div>

<script>
    // ÈÅäÊà≤ÁãÄÊÖãËÆäÊï∏
    let currentQuestionIndex = 0;
    let score = 0;
    let selectedOption = null;
    let quizData = null;
    let canSelect = true;
    let totalQuestions = 0;
    let userAnswers = []; // ÂÑ≤Â≠òÁî®Êà∂ÁöÑÁ≠îÊ°à
    let userResults = []; // ÂÑ≤Â≠òÊØèÈ°åÁöÑÂ∞çÈåØÁµêÊûú
    let sectionPerformance = {}; // ÂÑ≤Â≠òÂ∞èÁØÄË°®ÁèæÊï∏Êìö
    let randomizedQuestions = []; // Èö®Ê©üÊéíÂ∫èÂæåÁöÑÈ°åÁõÆ
    let originalQuestionOrder = []; // ÂéüÂßãÈ°åÁõÆÈ†ÜÂ∫èÊò†Â∞Ñ

    // ËºâÂÖ•Ê∏¨È©óÊï∏Êìö
    async function loadQuizData() {
        try {
            const response = await fetch('QuizData.json');
            if (!response.ok) {
                throw new Error('ÁÑ°Ê≥ïËºâÂÖ•È°åÁõÆÊï∏Êìö');
            }
            quizData = await response.json();
            initializeQuiz();
        } catch (error) {
            console.error('ËºâÂÖ•Êï∏ÊìöÂ§±Êïó:', error);
            document.getElementById('q-text').innerText = '‚ùå ÁÑ°Ê≥ïËºâÂÖ•È°åÁõÆÊï∏ÊìöÔºåË´ãÊ™¢Êü• QuizData.json Ê™îÊ°àÊòØÂê¶Â≠òÂú®';
        }
    }

    // ÂàùÂßãÂåñÊ∏¨È©ó
    function initializeQuiz() {
        if (!quizData || !quizData.questions || quizData.questions.length === 0) {
            document.getElementById('q-text').innerText = '‚ùå Ê≤íÊúâÂèØÁî®ÁöÑÈ°åÁõÆÊï∏Êìö';
            return;
        }
        
        // Èö®Ê©üÊéíÂ∫èÈ°åÁõÆ
        randomizeQuestions();
        
        totalQuestions = randomizedQuestions.length;
        userAnswers = new Array(totalQuestions).fill(null);
        userResults = new Array(totalQuestions).fill(false);
        sectionPerformance = {};
        
        // ÂàùÂßãÂåñÂ∞èÁØÄË°®ÁèæÊï∏Êìö
        randomizedQuestions.forEach((question, index) => {
            const section = question.section;
            if (!sectionPerformance[section]) {
                sectionPerformance[section] = {
                    total: 0,
                    correct: 0,
                    questionIndices: []
                };
            }
            sectionPerformance[section].total++;
            sectionPerformance[section].questionIndices.push(index);
        });
        
        // Êõ¥Êñ∞ÈÄ≤Â∫¶ËøΩËπ§
        updateProgressInfo();
        
        // ËºâÂÖ•Á¨¨‰∏ÄÈ°å
        loadQuestion();
    }

    // Èö®Ê©üÊéíÂ∫èÈ°åÁõÆ
    function randomizeQuestions() {
        if (!quizData) return;
        
        // Ë§áË£ΩÂéüÂßãÈ°åÁõÆ
        const questionsCopy = [...quizData.questions];
        
        // Â∞çÊØèÂÄãÂ∞èÁØÄÂÖßÁöÑÈ°åÁõÆÈÄ≤Ë°åÈö®Ê©üÊéíÂ∫è
        const sections = {};
        
        // ÊåâÂ∞èÁØÄÂàÜÁµÑ
        questionsCopy.forEach(question => {
            if (!sections[question.section]) {
                sections[question.section] = [];
            }
            sections[question.section].push(question);
        });
        
        // Èö®Ê©üÊéíÂ∫èÊØèÂÄãÂ∞èÁØÄÂÖßÁöÑÈ°åÁõÆ
        Object.keys(sections).forEach(section => {
            sections[section] = shuffleArray(sections[section]);
        });
        
        // Âêà‰ΩµÊâÄÊúâÂ∞èÁØÄÁöÑÈ°åÁõÆÔºà‰øùÊåÅÂ∞èÁØÄÈ†ÜÂ∫èÔºâ
        randomizedQuestions = [];
        const sectionOrder = ['Â∞èÁØÄ‰∏ÄÔºöÂÆ∂Â±ÖÂç±Ê©üÔºàÁÅ´Ë≠¶ËàáÊ∞£È´îÔºâ', 'Â∞èÁØÄ‰∫åÔºöÈÉäÈÅäËàáÊÄ•Êïë', 'Â∞èÁØÄ‰∏âÔºöÈÅìË∑ØÂÆâÂÖ®ËàáÊïëÊè¥'];
        
        sectionOrder.forEach(section => {
            if (sections[section]) {
                randomizedQuestions.push(...sections[section]);
            }
        });
        
        // Ë®òÈåÑÂéüÂßãÈ°åÁõÆÈ†ÜÂ∫èÊò†Â∞Ñ
        originalQuestionOrder = randomizedQuestions.map((q, index) => {
            return quizData.questions.findIndex(originalQ => 
                originalQ.q === q.q && originalQ.section === q.section
            );
        });
    }

    // Fisher-Yates Ê¥óÁâåÁÆóÊ≥ï
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Êõ¥Êñ∞ÈÄ≤Â∫¶ËøΩËπ§Ë≥áË®ä
    function updateProgressInfo() {
        document.getElementById('completed-count').textContent = currentQuestionIndex;
        document.getElementById('remaining-count').textContent = totalQuestions - currentQuestionIndex;
    }

    // ËºâÂÖ•È°åÁõÆ
    function loadQuestion() {
        if (!randomizedQuestions || randomizedQuestions.length === 0) return;
        
        const question = randomizedQuestions[currentQuestionIndex];
        
        // Êõ¥Êñ∞ÈÄ≤Â∫¶ËøΩËπ§
        updateProgressInfo();
        
        // Êõ¥Êñ∞È°åÁõÆÁ∑®Ëôü
        document.getElementById('current-q').textContent = currentQuestionIndex + 1;
        
        // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
        const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
        document.getElementById('pb').style.width = `${progress}%`;
        
        // È°ØÁ§∫Â∞èÁØÄÂêçÁ®±
        document.getElementById('section-name').textContent = question.section;
        
        // È°ØÁ§∫È°åÁõÆ
        document.getElementById('q-text').textContent = question.q;
        
        // Ê∏ÖÁ©∫‰∏¶ÈáçÂª∫ÈÅ∏È†Ö
        const optionsList = document.getElementById('opt-list');
        optionsList.innerHTML = '';
        
        // ÂâµÂª∫ÈÅ∏È†Ö
        question.o.forEach((optionText, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.textContent = optionText;
            optionDiv.dataset.index = index;
            
            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂Áõ£ËÅΩÂô®
            optionDiv.addEventListener('click', () => selectOption(optionDiv, index));
            
            optionsList.appendChild(optionDiv);
        });
        
        // ÈáçÁΩÆÁãÄÊÖã
        selectedOption = null;
        canSelect = true;
        document.getElementById('check-btn').disabled = true;
        
        // Á¢∫‰øùÂèçÈ•ãÈù¢ÊùøÈö±Ëóè
        document.getElementById('feedback-tray').style.bottom = '-350px';
        
        // Êõ¥Êñ∞‰∏ã‰∏ÄÈ°åÊåâÈàïÊñáÂ≠ó
        updateNextButtonText();
    }

    // Êõ¥Êñ∞‰∏ã‰∏ÄÈ°åÊåâÈàïÊñáÂ≠ó
    function updateNextButtonText() {
        const nextButton = document.getElementById('next-btn-text');
        const isLastQuestion = currentQuestionIndex === totalQuestions - 1;
        
        if (isLastQuestion) {
            nextButton.textContent = 'Êü•ÁúãÁµêÊûú';
        } else {
            nextButton.textContent = '‰∏ã‰∏ÄÈ°å';
        }
    }

    // ÈÅ∏ÊìáÈÅ∏È†Ö
    function selectOption(optionElement, optionIndex) {
        if (!canSelect) return;
        
        // ÁßªÈô§ÊâÄÊúâÈÅ∏È†ÖÁöÑ active È°û
        document.querySelectorAll('.option-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Ê∑ªÂä†Áï∂ÂâçÈÅ∏È†ÖÁöÑ active È°û
        optionElement.classList.add('active');
        
        // ‰øùÂ≠òÈÅ∏Êìá
        selectedOption = optionIndex;
        
        // ÂïüÁî®Ê™¢Êü•Á≠îÊ°àÊåâÈàï
        document.getElementById('check-btn').disabled = false;
    }

    // Ê™¢Êü•Á≠îÊ°à
    function handleCheck() {
        if (selectedOption === null || !canSelect || !randomizedQuestions) return;
        
        const question = randomizedQuestions[currentQuestionIndex];
        const feedbackTray = document.getElementById('feedback-tray');
        const trayTitle = document.getElementById('tray-title');
        const trayDesc = document.getElementById('tray-desc');
        
        // Á¶ÅÊ≠¢ÂÜçÊ¨°ÈÅ∏Êìá
        canSelect = false;
        
        // ‰øùÂ≠òÁî®Êà∂Á≠îÊ°àÂíåÁµêÊûú
        userAnswers[currentQuestionIndex] = selectedOption;
        const isCorrect = selectedOption === question.a;
        userResults[currentQuestionIndex] = isCorrect;
        
        // Êõ¥Êñ∞Â∞èÁØÄË°®ÁèæÊï∏Êìö
        if (isCorrect) {
            score++;
            sectionPerformance[question.section].correct++;
        }
        
        // È´ò‰∫ÆÈ°ØÁ§∫Ê≠£Á¢∫ÂíåÈåØË™§Á≠îÊ°à
        const allOptions = document.querySelectorAll('.option-item');
        allOptions.forEach((option, index) => {
            if (index === question.a) {
                option.classList.add('correct');
            } else if (index === selectedOption && selectedOption !== question.a) {
                option.classList.add('wrong');
            }
        });
        
        // È°ØÁ§∫ÂèçÈ•ã
        if (isCorrect) {
            feedbackTray.className = 'tray-correct';
            trayTitle.textContent = 'Á≠îÂ∞ç‰∫ÜÔºÅ';
        } else {
            feedbackTray.className = 'tray-wrong';
            trayTitle.textContent = 'ÂÜçÊé•ÂÜçÂé≤ÔºÅ';
        }
        
        trayDesc.textContent = question.d;
        feedbackTray.style.bottom = '0';
        
        // Á¶ÅÁî®Ê™¢Êü•ÊåâÈàï
        document.getElementById('check-btn').disabled = true;
    }

    // ËºâÂÖ•‰∏ã‰∏ÄÈ°å
    function loadNext() {
        // Èö±ËóèÂèçÈ•ãÈù¢ÊùøÔºà‰øÆÂæ©bugÔºâ
        document.getElementById('feedback-tray').style.bottom = '-350px';
        
        currentQuestionIndex++;
        
        if (currentQuestionIndex < totalQuestions) {
            loadQuestion();
        } else {
            // È°ØÁ§∫ÊúÄÁµÇÁµêÊûú
            showFinalScreen();
        }
    }

    // È°ØÁ§∫ÊúÄÁµÇÁµêÊûúÁï´Èù¢
    function showFinalScreen() {
        // Á¢∫‰øùÂèçÈ•ãÈù¢ÊùøÈö±ËóèÔºà‰øÆÂæ©bugÔºâ
        document.getElementById('feedback-tray').style.bottom = '-350px';
        
        document.getElementById('quiz-ui').style.display = 'none';
        document.getElementById('footer-bar').style.display = 'none';
        document.getElementById('section-name').style.display = 'none';
        document.getElementById('progress-info').style.display = 'none';
        document.getElementById('pb').style.width = '100%';
        document.getElementById('final-screen').style.display = 'block';
        
        const scorePercent = Math.round((score / totalQuestions) * 100);
        let message = '‰Ω†ÂÆåÊàê‰∫ÜÊâÄÊúâÊåëÊà∞ÔºÅ';
        
        if (scorePercent === 100) {
            message = 'üéâ ÂÆåÁæéÔºÅ‰Ω†ÊòØÂÆâÂÖ®Áü•Ë≠òÈÅî‰∫∫ÔºÅ';
        } else if (scorePercent >= 80) {
            message = 'üëç ÂÑ™ÁßÄÔºÅ‰Ω†Â∞çÂÆâÂÖ®Áü•Ë≠òÊéåÊè°ÂæóÂæàÂ•ΩÔºÅ';
        } else if (scorePercent >= 60) {
            message = 'üëå ‰∏çÈåØÔºÅÁπºÁ∫åÂ≠∏ÁøíÊúÉÊõ¥ÂÆâÂÖ®ÔºÅ';
        } else {
            message = 'üí™ ÂÜçË§áÁøí‰∏Ä‰∏ãÊúÉÊõ¥ÂÆâÂÖ®ÂñîÔºÅ';
        }
        
        document.getElementById('final-msg').textContent = message;
        document.getElementById('final-score').textContent = `${score} / ${totalQuestions}`;
        
        // È°ØÁ§∫ÂÖ®Â∞çÂ∞èÁØÄÂæΩÁ´†
        displayPerfectSectionBadges();
        
        // È°ØÁ§∫Â∞èÁØÄË°®Áèæ
        displaySectionPerformance();
    }

    // È°ØÁ§∫ÂÖ®Â∞çÂ∞èÁØÄÂæΩÁ´†
    function displayPerfectSectionBadges() {
        const container = document.getElementById('perfect-sections-container');
        container.innerHTML = '';
        
        // ÊâæÂá∫ÂÖ®Â∞çÁöÑÂ∞èÁØÄ
        const perfectSections = [];
        
        Object.keys(sectionPerformance).forEach(section => {
            const performance = sectionPerformance[section];
            const scorePercent = Math.round((performance.correct / performance.total) * 100);
            
            if (scorePercent === 100) {
                perfectSections.push({
                    name: section,
                    correct: performance.correct,
                    total: performance.total
                });
            }
        });
        
        // Â¶ÇÊûúÊúâÂÖ®Â∞çÁöÑÂ∞èÁØÄÔºåÈ°ØÁ§∫ÂæΩÁ´†
        if (perfectSections.length > 0) {
            perfectSections.forEach(section => {
                const badge = document.createElement('div');
                badge.className = 'perfect-section-badge';
                badge.innerHTML = `
                    <span class="badge-icon">üèÖ</span>
                    <span>${section.name.replace('Â∞èÁØÄ‰∏ÄÔºö', '').replace('Â∞èÁØÄ‰∫åÔºö', '').replace('Â∞èÁØÄ‰∏âÔºö', '')}</span>
                    <span>(${section.correct}/${section.total})</span>
                `;
                container.appendChild(badge);
            });
        }
    }

    // È°ØÁ§∫Â∞èÁØÄË°®Áèæ
    function displaySectionPerformance() {
        const container = document.getElementById('section-performance-container');
        container.innerHTML = '';
        
        // Ë®àÁÆóÊúÄ‰Ω≥ÂíåÊúÄÂ∑ÆÂ∞èÁØÄ
        let bestSection = null;
        let bestScore = -1;
        let worstSection = null;
        let worstScore = 101;
        
        Object.keys(sectionPerformance).forEach(section => {
            const performance = sectionPerformance[section];
            const scorePercent = Math.round((performance.correct / performance.total) * 100);
            
            if (scorePercent > bestScore) {
                bestScore = scorePercent;
                bestSection = section;
            }
            
            if (scorePercent < worstScore) {
                worstScore = scorePercent;
                worstSection = section;
            }
        });
        
        // ÂâµÂª∫Â∞èÁØÄÊØîËºÉÊ®ôÈ°å
        const comparisonDiv = document.createElement('div');
        comparisonDiv.className = 'section-comparison';
        
        const comparisonTitle = document.createElement('div');
        comparisonTitle.className = 'comparison-title';
        comparisonTitle.textContent = 'üìà ÂêÑÂ∞èÁØÄË°®ÁèæÊØîËºÉ';
        comparisonDiv.appendChild(comparisonTitle);
        
        container.appendChild(comparisonDiv);
        
        // ÁÇ∫ÊØèÂÄãÂ∞èÁØÄÂâµÂª∫Ë°®ÁèæÂç°Áâá
        Object.keys(sectionPerformance).forEach(section => {
            const performance = sectionPerformance[section];
            const scorePercent = Math.round((performance.correct / performance.total) * 100);
            const isPerfect = scorePercent === 100;
            
            const card = document.createElement('div');
            card.className = 'performance-card';
            
            // Ê®ôË®òË°®ÁèæÈ°ûÂûã
            if (isPerfect) {
                card.classList.add('performance-perfect');
                // Ê∑ªÂä†ÂÖ®Â∞çÂæΩÁ´†
                const perfectBadge = document.createElement('div');
                perfectBadge.className = 'perfect-badge';
                perfectBadge.textContent = 'ÂÖ®Â∞ç üéØ';
                card.appendChild(perfectBadge);
            } else if (section === bestSection) {
                card.classList.add('performance-best');
            } else if (section === worstSection) {
                card.classList.add('performance-worst');
            }
            
            // Ê®ôÈ°åÈÉ®ÂàÜ
            const header = document.createElement('div');
            header.className = 'performance-header';
            
            const title = document.createElement('div');
            title.className = 'performance-title';
            title.textContent = section;
            
            if (isPerfect) {
                const perfectBadge = document.createElement('span');
                perfectBadge.className = 'best-section-badge';
                perfectBadge.textContent = 'ÂÆåÁæé';
                title.appendChild(perfectBadge);
            } else if (section === bestSection && !isPerfect) {
                const bestBadge = document.createElement('span');
                bestBadge.className = 'best-section-badge';
                bestBadge.textContent = 'ÊúÄ‰Ω≥Ë°®Áèæ';
                title.appendChild(bestBadge);
            } else if (section === worstSection) {
                const worstBadge = document.createElement('span');
                worstBadge.className = 'worst-section-badge';
                worstBadge.textContent = 'ÈúÄË¶ÅÂä†Âº∑';
                title.appendChild(worstBadge);
            }
            
            const score = document.createElement('div');
            score.className = 'performance-score';
            score.style.color = isPerfect ? 'var(--duo-green)' : 
                              scorePercent >= 80 ? 'var(--duo-green)' : 
                              scorePercent >= 60 ? 'var(--duo-blue)' : 
                              'var(--duo-red)';
            score.textContent = `${performance.correct}/${performance.total}`;
            
            header.appendChild(title);
            header.appendChild(score);
            card.appendChild(header);
            
            // ÈÄ≤Â∫¶Ê¢ù
            const bar = document.createElement('div');
            bar.className = 'performance-bar';
            
            const fill = document.createElement('div');
            fill.className = 'performance-fill';
            fill.style.width = `${scorePercent}%`;
            fill.style.backgroundColor = isPerfect ? 'var(--duo-green)' : 
                                         scorePercent >= 80 ? 'var(--duo-green)' : 
                                         scorePercent >= 60 ? 'var(--duo-blue)' : 
                                         'var(--duo-red)';
            
            bar.appendChild(fill);
            card.appendChild(bar);
            
            // Áµ±Ë®àÊï∏Êìö
            const stats = document.createElement('div');
            stats.className = 'performance-stats';
            
            const percent = document.createElement('div');
            percent.textContent = `Ê≠£Á¢∫Áéá: ${scorePercent}%`;
            
            const count = document.createElement('div');
            count.textContent = `È°åÊï∏: ${performance.total}È°å`;
            
            stats.appendChild(percent);
            stats.appendChild(count);
            card.appendChild(stats);
            
            container.appendChild(card);
        });
    }

    // È°ØÁ§∫Á≠îÈ°åÂõûÈ°ß
    function showReview() {
        document.getElementById('final-screen').style.display = 'none';
        document.getElementById('review-screen').style.display = 'block';
        
        // Êõ¥Êñ∞ÂõûÈ°ßÈ†ÅÈù¢ÁöÑÂàÜÊï∏
        document.getElementById('review-score').textContent = `${score} / ${totalQuestions}`;
        
        // ÁîüÊàêÂõûÈ°ßÂÖßÂÆπ
        const reviewList = document.getElementById('review-list');
        reviewList.innerHTML = '';
        
        let currentSection = '';
        
        randomizedQuestions.forEach((question, index) => {
            const userAnswer = userAnswers[index];
            const isCorrect = userResults[index];
            const correctAnswer = question.a;
            
            // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÈ°ØÁ§∫Â∞èÁØÄÊ®ôÈ°å
            if (question.section !== currentSection) {
                currentSection = question.section;
                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'review-section-title';
                sectionTitle.textContent = currentSection;
                reviewList.appendChild(sectionTitle);
            }
            
            // ÂâµÂª∫ÂõûÈ°ßÈ†ÖÁõÆ
            const reviewItem = document.createElement('div');
            reviewItem.className = 'review-item';
            
            // È°åÁõÆ
            const questionDiv = document.createElement('div');
            questionDiv.className = 'review-question';
            questionDiv.textContent = `${index + 1}. ${question.q}`;
            reviewItem.appendChild(questionDiv);
            
            // ÈÅ∏È†Ö
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'review-options';
            
            question.o.forEach((option, optionIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'review-option';
                optionDiv.textContent = option;
                
                // Ê®ôË®òÊ≠£Á¢∫Á≠îÊ°à
                if (optionIndex === correctAnswer) {
                    optionDiv.classList.add('review-correct-option');
                }
                
                // Ê®ôË®òÁî®Êà∂Á≠îÊ°à
                if (optionIndex === userAnswer) {
                    optionDiv.classList.add('review-user-answer');
                    if (!isCorrect) {
                        optionDiv.classList.add('review-wrong-answer');
                    }
                }
                
                optionsDiv.appendChild(optionDiv);
            });
            
            reviewItem.appendChild(optionsDiv);
            
            // Á≠îÈ°åÁµêÊûú
            const resultDiv = document.createElement('div');
            resultDiv.className = `review-result ${isCorrect ? 'review-result-correct' : 'review-result-wrong'}`;
            resultDiv.textContent = isCorrect ? '‚úì Á≠îÂ∞ç‰∫Ü' : '‚úó Á≠îÈåØ‰∫Ü';
            reviewItem.appendChild(resultDiv);
            
            // Á≠îÊ°àËß£Êûê
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'review-explanation';
            explanationDiv.textContent = question.d;
            reviewItem.appendChild(explanationDiv);
            
            reviewList.appendChild(reviewItem);
        });
        
        // ÊªæÂãïÂà∞È†ÇÈÉ®
        window.scrollTo(0, 0);
    }

    // ÂæûÂõûÈ°ßÁï´Èù¢ËøîÂõûÊúÄÁµÇÁµêÊûúÁï´Èù¢
    function showFinalScreen() {
        document.getElementById('review-screen').style.display = 'none';
        document.getElementById('final-screen').style.display = 'block';
    }

    // È†ÅÈù¢ËºâÂÖ•ÊôÇÈñãÂßã
    document.addEventListener('DOMContentLoaded', loadQuizData);
    
    // Ê∑ªÂä†ÈçµÁõ§Âø´Êç∑ÈçµÊîØÊè¥
    document.addEventListener('keydown', function(event) {
        if (event.key >= '1' && event.key <= '4' && canSelect) {
            const optionIndex = parseInt(event.key) - 1;
            const options = document.querySelectorAll('.option-item');
            if (optionIndex < options.length) {
                selectOption(options[optionIndex], optionIndex);
            }
        } else if (event.key === 'Enter' && !document.getElementById('check-btn').disabled) {
            handleCheck();
        } else if (event.key === ' ' && document.getElementById('feedback-tray').style.bottom === '0px') {
            loadNext();
        }
    });
</script>
</body>
</html>