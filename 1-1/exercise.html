<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P6 å¸¸è­˜ç§‘ï¼šæ€¥æ•‘èˆ‡å®‰å…¨ (ç¶œåˆç·´ç¿’)</title>
    <style>
        /* ... (Keep previous styles) ... */
        :root {
            --duo-sky: #dcf5ff;
            --duo-green: #58cc02;
            --duo-green-shadow: #46a302;
            --duo-red: #ff4b4b;
            --duo-red-shadow: #ea2b2b;
            --duo-blue: #1cb0f6;
            --duo-blue-shadow: #1899d6;
            --duo-gray: #e5e5e5;
            --duo-text: #4b4b4b;
            --card-border: #e5e5e5;
        }

        body {
            font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif;
            background-color: var(--duo-sky);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--duo-text);
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Header & Nav Styles */
        .header-banner { background-color: var(--duo-green); color: white; padding: 20px 20px 30px 20px; text-align: center; position: relative; }
        .banner-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .banner-subtitle { font-size: 14px; opacity: 0.9; }
        .progress-track { position: absolute; bottom: 10px; left: 20px; right: 20px; height: 6px; background-color: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: rgba(255,255,255,0.9); width: 0%; transition: width 0.5s ease; border-radius: 3px; }
        .status-bar { background-color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; font-size: 14px; font-weight: bold; color: #777; }
        
        .nav-grid-container { padding: 10px 20px; background: #f9f9f9; border-bottom: 1px solid #eee; display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 8px; max-height: 150px; overflow-y: auto; }
        .nav-btn { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #ddd; background: white; font-size: 12px; font-weight: bold; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .nav-btn:hover { background: #eee; }
        .nav-btn.active { border-color: var(--duo-blue); color: var(--duo-blue); background: #eef9ff; transform: scale(1.1); }
        .nav-btn.correct { background: var(--duo-green); color: white; border-color: var(--duo-green-shadow); }
        .nav-btn.wrong { background: var(--duo-red); color: white; border-color: var(--duo-red-shadow); }

        /* Question Area */
        .question-area { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .question-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .page-badge { background-color: var(--duo-blue); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        h1.question-text { font-size: 19px; margin-bottom: 25px; line-height: 1.6; font-weight: bold; color: #3c3c3c; }

        /* Modes */
        .case-study-container { display: flex; flex-direction: column; gap: 20px; }
        @media (min-width: 600px) { .case-study-container { flex-direction: row; } }
        .case-image-box { flex: 1; border: 2px solid var(--card-border); border-radius: 12px; padding: 10px; background: #fafafa; }
        .case-image-box img { width: 100%; height: auto; border-radius: 8px; }
        .case-questions-box { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .sub-question { background: white; border: 1px solid #eee; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sub-q-label { font-weight: bold; color: var(--duo-blue); margin-bottom: 8px; font-size: 14px; }
        .sub-q-text { font-weight: bold; margin-bottom: 10px; }

        .input-container { width: 100%; margin-bottom: 20px; }
        .input-field { width: 100%; padding: 15px; font-size: 18px; border: 2px solid var(--duo-gray); border-radius: 12px; background-color: #f7f7f7; color: #333; box-sizing: border-box; outline: none; transition: all 0.2s; font-family: inherit; }
        .input-field:focus { border-color: var(--duo-blue); background-color: white; box-shadow: 0 0 0 2px rgba(28, 176, 246, 0.2); }

        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .options-grid.tf-mode { grid-template-columns: 1fr 1fr; } 
        .options-grid.image-mode { grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .option-card { border: 2px solid var(--card-border); border-bottom: 4px solid var(--card-border); border-radius: 16px; padding: 15px; text-align: left; cursor: pointer; font-size: 16px; transition: all 0.1s; background: white; user-select: none; display: flex; align-items: center; }
        .option-card.center-text { justify-content: center; font-weight: bold; font-size: 20px; } 
        .option-card.has-image { flex-direction: column; padding: 10px; height: 100%; align-items: center; justify-content: flex-start; }
        .option-image-container { width: 100%; height: 140px; background-color: #f0f0f0; border-radius: 12px; margin-bottom: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; }
        .option-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .option-label { font-weight: bold; font-size: 18px; color: var(--duo-text); }

        .option-card:active { transform: translateY(2px); border-bottom-width: 2px; }
        .option-card.selected { border-color: var(--duo-blue); background-color: #ddf4ff; border-bottom-color: var(--duo-blue-shadow); color: var(--duo-blue-shadow); }
        /* Multi-select active style (same as selected for now, logic handles multiple) */
        
        .option-card.correct { border-color: var(--duo-green); background-color: #d7ffb8; border-bottom-color: var(--duo-green-shadow); color: var(--duo-green-shadow); }
        .option-card.wrong { border-color: var(--duo-red); background-color: #ffdfe0; border-bottom-color: var(--duo-red-shadow); color: var(--duo-red-shadow); }
        /* Missing correct style for unselected correct answers in multi mode */
        .option-card.missed { border-color: var(--duo-green); border-style: dashed; background-color: #f0fff0; color: var(--duo-green-shadow); }

        .sequence-area { margin-top: 10px; }
        .slots-container { min-height: 60px; border-bottom: 2px solid #e5e5e5; padding: 10px 0; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px; }
        .word-bank { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .word-bubble { background: white; border: 2px solid var(--card-border); border-bottom: 4px solid var(--card-border); border-radius: 12px; padding: 8px 12px; font-size: 15px; cursor: pointer; user-select: none; }
        .word-bubble:active { transform: translateY(2px); border-bottom-width: 2px; }
        .word-bubble.in-slot { border-color: var(--duo-blue); }
        .word-bubble.placeholder { background: #e5e5e5; border-color: transparent; color: transparent; pointer-events: none; }

        .footer { padding: 20px; border-top: 2px solid var(--duo-gray); background: white; margin-top: auto; }
        .btn-check { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; color: white; background-color: var(--duo-green); border: none; border-radius: 16px; border-bottom: 4px solid var(--duo-green-shadow); cursor: pointer; letter-spacing: 1px; transition: background 0.2s; }
        .btn-check:disabled { background-color: var(--duo-gray); border-bottom-color: #ccc; color: #afafaf; cursor: default; }

        .mascot-container { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .mascot { width: 50px; height: 50px; background: #FFC107; border-radius: 50%; border: 3px solid #eebb00; position: relative; flex-shrink: 0; }
        .speech-bubble { border: 2px solid var(--card-border); padding: 10px 14px; border-radius: 12px; background: white; position: relative; font-size: 14px; color: #3c3c3c; font-weight: bold; }

        .feedback-overlay { position: fixed; bottom: 0; left: 0; right: 0; min-height: 180px; background: white; transform: translateY(100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; z-index: 100; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); }
        .feedback-overlay.show { transform: translateY(0); }
        .feedback-overlay.correct { background-color: #d7ffb8; color: var(--duo-green-shadow); }
        .feedback-overlay.wrong { background-color: #ffdfe0; color: var(--duo-red-shadow); }
        .feedback-header { font-size: 22px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .btn-continue { margin-top: 15px; background-color: var(--duo-green); border-bottom-color: var(--duo-green-shadow); }
        .feedback-overlay.wrong .btn-continue { background-color: var(--duo-red); border-bottom-color: var(--duo-red-shadow); }

        .end-screen { display: none; padding: 30px 20px; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box; overflow-y: auto; }
        .end-title { color: var(--duo-green); font-size: 28px; margin-bottom: 20px; font-weight: bold; text-align: center; }
        .score-board { display: flex; gap: 15px; margin-bottom: 30px; width: 100%; justify-content: center; }
        .score-box { padding: 15px 25px; border-radius: 12px; text-align: center; color: white; min-width: 80px; }
        .score-val { font-size: 24px; font-weight: bold; }
        .score-lbl { font-size: 12px; opacity: 0.9; }
        .review-list { width: 100%; display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .review-item { border: 2px solid #e5e5e5; border-radius: 12px; padding: 15px; background: #fff; position: relative; }
        .review-item.correct { border-left: 5px solid var(--duo-green); }
        .review-item.wrong { border-left: 5px solid var(--duo-red); background-color: #fff5f5; }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #888; }
        .review-q { font-weight: bold; margin-bottom: 10px; color: #333; font-size: 16px; }
        .review-feedback { background-color: #f0f0f0; border-radius: 8px; padding: 10px; font-size: 14px; margin-top: 10px; }
        .review-ans-label { font-weight: bold; display: block; margin-bottom: 4px; }
        .ans-wrong { color: var(--duo-red); text-decoration: line-through; margin-right: 10px; }
        .ans-correct { color: var(--duo-green); font-weight: bold; }

    </style>
</head>
<body>

<div class="app-container">
    <div class="header-banner" id="header-banner">
        <div class="banner-title">ğŸ¦Œ P6 å¸¸è­˜ç§‘ç·´ç¿’</div>
        <div class="banner-subtitle">æ€¥æ•‘èˆ‡å®‰å…¨ (å…¨å·ç¶œåˆç·´ç¿’)</div>
        <div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div>
    </div>
    <div class="status-bar" id="status-bar">
        <div class="status-left" id="question-tracker">é¡Œç›® 1/33</div>
        <div class="status-right" id="score-tracker">æ­£ç¢º: 0 | ä¸æ­£ç¢º: 0</div>
    </div>
    <div class="nav-grid-container" id="nav-grid"></div>

    <div id="quiz-screen" style="display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;">
        <div class="question-area" id="question-area"></div>
        <div class="footer">
            <button class="btn-check" id="check-btn" disabled onclick="checkAnswer()">æª¢æŸ¥</button>
        </div>
    </div>

    <div id="end-screen" class="end-screen">
        <div class="end-title">ç·´ç¿’å®Œæˆï¼</div>
        <div class="score-board">
            <div class="score-box" style="background:var(--duo-green);"><div class="score-val" id="final-correct">0</div><div class="score-lbl">æ­£ç¢º</div></div>
            <div class="score-box" style="background:var(--duo-red);"><div class="score-val" id="final-incorrect">0</div><div class="score-lbl">ä¸æ­£ç¢º</div></div>
        </div>
        <h3 style="align-self: flex-start; margin-bottom: 15px; color:#555;">é¡Œç›®å›é¡§ (Review)</h3>
        <div class="review-list" id="review-list"></div>
        <button class="btn-check" onclick="location.reload()">å†åšä¸€æ¬¡</button>
    </div>
</div>

<div class="feedback-overlay" id="feedback-overlay">
    <div class="feedback-header" id="feedback-title"><span>æ­£ç¢ºï¼</span></div>
    <div class="feedback-message" id="feedback-message"></div>
    <button class="btn-check btn-continue" onclick="nextQuestion()">ç¹¼çºŒ</button>
</div>

<script>
    const questions = [
        { id: 1, type: "mc_image_grid", page: "6", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„åœ–ç‰‡ï¼š", question: "1. ä»¥ä¸‹å“ªå€‹æ˜¯è™•ç†æ˜å¥çš„æ­£ç¢ºæ–¹æ³•ï¼Ÿ", options: [{ label: "A", img: "img/option1-1.jpg" }, { label: "B", img: "img/option1-2.jpg" }, { label: "C", img: "img/option1-3.jpg" }], correct: 2, explanation: "æ˜å¥è™•ç†ï¼šæ‡‰è®“æ‚£è€…å¹³è‡¥ï¼Œå¢Šé«˜é›™è…³ï¼Œä»¥å¢åŠ è…¦éƒ¨è¡€æ¶²ä¾›æ‡‰ã€‚" },
        { id: 2, type: "mc_image_grid", page: "6", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„åœ–ç‰‡ï¼š", question: "2. ä»¥ä¸‹å“ªå€‹æ˜¯è™•ç†ç‡™å‚·çš„æ­£ç¢ºæ–¹æ³•ï¼Ÿ", options: [{ label: "A", img: "img/option2-1.jpg" }, { label: "B", img: "img/option2-2.jpg" }, { label: "C", img: "img/option2-3.jpg" }], correct: 2, explanation: "ç‡™å‚·è™•ç†ï¼šæ‡‰ç«‹å³ç”¨æ¸…æ°´æ²–æ´—å‚·å£é™æº«ï¼Œåˆ‡å‹¿å¡—æŠ¹ç‰™è†æˆ–è±‰æ²¹ã€‚" },
        { id: 3, type: "tf", page: "5", instruction: "åˆ¤æ–·å¥å­æè¿°æ˜¯å¦æ­£ç¢ºï¼š", question: "éƒŠéŠæ™‚å®¹æ˜“ç™¼ç”Ÿæ„å¤–ï¼Œæ‰€ä»¥æ‡‰å„˜é‡é¿å…åƒåŠ æˆ¶å¤–æ´»å‹•ã€‚", options: ["æ­£ç¢º âœ”ï¸", "ä¸æ­£ç¢º âŒ"], correct: 1, explanation: "ä¸æ­£ç¢ºã€‚æ‡‰åšå¥½æº–å‚™å’Œæ³¨æ„å®‰å…¨ï¼Œè€Œä¸æ˜¯å®Œå…¨é¿å…ã€‚" },
        { id: 4, type: "tf", page: "5", instruction: "åˆ¤æ–·å¥å­æè¿°æ˜¯å¦æ­£ç¢ºï¼š", question: "ç™¼ç¾å®¶è£æœ‰æ°£é«”æ³„æ¼ï¼Œé ˆå³æ™‚æ‰“ 999 æ±‚åŠ©ã€‚", options: ["æ­£ç¢º âœ”ï¸", "ä¸æ­£ç¢º âŒ"], correct: 1, explanation: "ä¸æ­£ç¢ºã€‚æ‡‰å…ˆé—œæ‰ç¸½æ£ä¸¦åˆ°å®‰å…¨é€šé¢¨è™•æ‰æ‰“é›»è©±ï¼Œé¿å…é›»è©±ç«èŠ±å¼•ç™¼çˆ†ç‚¸ã€‚" },
        { id: 5, type: "fill", page: "5", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘å€‘è¦åšå¥½é˜²ç«æªæ–½ï¼Œç†Ÿæ‚‰ä½è™•çš„ _______ å’Œé€ƒç”Ÿè·¯ç·šã€‚", options: ["æ¶ˆé˜²è¨­æ–½", "èµ°ç«é€šé“", "è­¦å‹™è™•", "ç†±è¡°ç«­"], correct: 1, explanation: "ç­”æ¡ˆï¼šèµ°ç«é€šé“ã€‚" },
        { id: 6, type: "fill", page: "5", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "æˆ‘å€‘ä¸æ‡‰ _______ ç·Šæ€¥æ•‘æ´æœå‹™ï¼Œä»¥å…çœŸæ­£æœ‰éœ€è¦çš„æ±‚åŠ©è€…å¾—ä¸åˆ°åŠæ™‚çš„å”åŠ©ã€‚", options: ["å–„ç”¨", "æ¿«ç”¨", "ä½¿ç”¨", "å‘¼å«"], correct: 1, explanation: "æˆ‘å€‘ä¸æ‡‰æ¿«ç”¨ç·Šæ€¥æœå‹™ã€‚" },
        { id: 7, type: "sequence", page: "4", instruction: "è«‹æŒ‰æ­£ç¢ºé †åºæ’åˆ—è™•ç†ã€Œæµé¼»è¡€ã€çš„æ­¥é©Ÿï¼š", question: "1. åŒå­¸æµé¼»è¡€æ‡‰æ€æ¨£è™•ç†ï¼Ÿ", options: ["A. è§£é–‹è¡£ç‰©", "B. åä¸‹", "C. é ­å‘å‰å‚¾", "D. æé¼»éª¨"], correct: [1, 2, 3, 0], explanation: "æ­£ç¢ºé †åºï¼šå…ˆåä¸‹ï¼Œé ­å‘å‰å‚¾ï¼Œæä½é¼»éª¨ï¼Œæœ€å¾Œè§£é–‹ç·Šèº«è¡£ç‰©ã€‚" },
        { id: 8, type: "fill", page: "5", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "_______ æ˜¯èº«é«”å› éåº¦æµæ±—è€Œå–ªå¤±æ°´åˆ†åŠé¹½åˆ†è€Œå‡ºç¾çš„åæ‡‰ã€‚", options: ["ä¸­æš‘", "ç†±è¡°ç«­", "ç‡’å‚·", "ç‡™å‚·"], correct: 1, explanation: "ç­”æ¡ˆï¼šç†±è¡°ç«­ã€‚" },
        { id: 9, type: "fill", page: "7", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "å¯«å‡ºå…©å€‹å¯èƒ½å¼•è‡´æ˜å¥çš„åŸå› ã€‚", options: ["éåº¦ç–²å‹/é£¢é¤“", "ç¡çœ å……è¶³/é‹å‹•", "å–æ°´/ä¼‘æ¯"], correct: 0, explanation: "ç­”æ¡ˆï¼šéåº¦ç–²å‹ã€é£¢é¤“ã€é©šæã€ç—›æ¥šæˆ–è²§è¡€ç­‰ã€‚" },
        { id: 10, type: "mc_image_grid", page: "7", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„åœ–ç‰‡ï¼š", question: "2. ä»¥ä¸‹å“ªå¥—æ˜¯éƒŠéŠæ™‚çš„æ­£ç¢ºè£æŸï¼Ÿ", options: [{ label: "A", img: "img/option3-1.jpg" }, { label: "B", img: "img/option3-2.jpg" }, { label: "C", img: "img/option3-3.jpg" }], correct: 0, explanation: "éƒŠéŠæ‡‰ç©¿è‘—è¼•ä¾¿ã€é€æ°£ä¸”ä¿è­·æ€§è‰¯å¥½çš„è¡£ç‰©ã€‚" },
        { id: 11, type: "fill", page: "7", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "ä¸å°å¿ƒè§¸ç¢°ç«ç„°æœƒå¼•èµ·ç”šéº¼å‚·æ‚£?", options: ["æ‰­å‚·", "æ’å‚·", "ç‡’å‚·", "ç‡™å‚·"], correct: 2, explanation: "ç­”æ¡ˆï¼šç‡’å‚·" },
        { id: 12, type: "fill", page: "7", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "ç‚ºç”šéº¼è¦æ›¿æ˜å¥çš„äººè§£é–‹è¡£ç‰©?", options: ["æœ‰åŠ©è¡€æ¶²å¾ªç’°", "ç‚ºäº†é™æº«", "ç‚ºäº†æª¢æŸ¥å‚·å£"], correct: 0, explanation: "ç­”æ¡ˆï¼šæ›¿æ˜å¥çš„äººè§£é–‹è¡£ç‰©ï¼Œæœ‰åŠ©è¡€æ¶²å¾ªç’°ã€‚" },
        { id: 13, type: "fill", page: "7", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "å¤šéƒ¨é›»å™¨å¾åŒä¸€å€‹æ’åº§è™•å–é›»ï¼Œæœ‰æ©Ÿæœƒå°è‡´ç”šéº¼å±éšª?", options: ["çŸ­è·¯/ç«è­¦", "åœé›»", "é›»å™¨æå£"], correct: 0, explanation: "çŸ­è·¯æˆ–ç«è­¦ã€‚" },
        {
            id: 14, type: "case_study", page: "8", instruction: "æ ¹æ“šä»¥ä¸‹æƒ…å¢ƒï¼Œå›ç­”å•é¡Œã€‚", img: "img/case_study.jpg", 
            subQuestions: [
                { qid: "1-1", text: "1. ç”šéº¼æ˜¯ã€Œé€ƒç”Ÿä¸‰å¯¶ã€ï¼Ÿ", type: "fill", options: ["æ‰‹æ©Ÿã€é‘°åŒ™ã€éŒ¢åŒ…", "æ¯›å·¾ã€é‘°åŒ™ã€æ‰‹æ©Ÿ", "æ°´ã€é£Ÿç‰©ã€æ¯›å·¾"], correct: 1, correctText: "æ¯›å·¾ã€é‘°åŒ™ã€æ‰‹æ©Ÿ" },
                { qid: "1-2", text: "2. ä»¥ä¸Šæƒ…å¢ƒä¸­ï¼Œèª°çš„åšæ³•æ˜¯å°çš„ï¼Ÿ", type: "mc", options: ["å®¶ä¿Š (ç•™åœ¨å±‹å…§)", "è©©çª (å¸¶ä¸‰å¯¶é€ƒç”Ÿ)"], correct: 1, correctText: "è©©çª (å¸¶ä¸‰å¯¶é€ƒç”Ÿ)" },
                { qid: "1-3", text: "3. æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘å€‘æ‡‰è©²åšå¥½å“ªäº›é˜²ç«æªæ–½ï¼Ÿ(è«‹å¡«å¯«ä¸€é …)", type: "text_input", correct: "ä¿æŒèµ°ç«é€šé“æš¢é€š", altCorrect: ["ç†Ÿæ‚‰é€ƒç”Ÿè·¯ç·š", "æª¢æŸ¥æ¶ˆé˜²è¨­æ–½", "ä¸é˜»å¡é˜²ç«é–€"], correctText: "ä¿æŒèµ°ç«é€šé“æš¢é€š" }
            ], explanation: "é€ƒç”Ÿä¸‰å¯¶ç‚ºï¼šæ¿•æ¯›å·¾ã€é‘°åŒ™ã€æ‰‹æ©Ÿã€‚æ¨“ä¸Šèµ·ç«æ‡‰å‘ä¸‹é€ƒç”Ÿã€‚"
        },
        { id: 15, type: "tf", page: "5", instruction: "åˆ¤æ–·å¥å­æè¿°æ˜¯å¦æ­£ç¢ºï¼š", question: "æ°‘çœ¾å®‰å…¨æœå‹™éšŠæœƒå”åŠ©æ•‘ç½ï¼Œé‚„æœƒæä¾›å±±é‡æœç´¢åŠæ•‘æ´æœå‹™ã€‚", options: ["æ­£ç¢º âœ”ï¸", "ä¸æ­£ç¢º âŒ"], correct: 0, explanation: "æ­£ç¢ºã€‚æ°‘å®‰éšŠè² è²¬å”åŠ©ç·Šæ€¥æ•‘ç½åŠå±±å¶ºæœæ•‘ã€‚" },
        { id: 16, type: "fill", page: "ç·´ç¿’å·", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "åœ¨é…·ç†±çš„å¤©æ°£ä¸‹é€²è¡Œæˆ¶å¤–æ´»å‹•æ™‚ï¼Œæˆ‘å€‘æ‡‰è©²ç©¿è‘— _______ è¡£æœï¼Œä»¥é˜²æ‚£ä¸Šç†±è¡°ç«­ã€‚", options: ["æ·ºè‰²ã€é€æ°£", "æ·±è‰²ã€ç·Šèº«", "åšé‡ã€ä¿æš–", "é®®è±”ã€åå…‰"], correct: 0, explanation: "æ·ºè‰²åŠé€æ°£çš„è¡£æœæœ‰åŠ©æ•£ç†±ã€‚" },
        { id: 17, type: "fill", page: "ç·´ç¿’å·", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "è¼•å¾®ç‡™å‚·æˆ–ç‡’å‚·çš„æ‚£è™•ä¸Šå¦‚å‡ºç¾ _______ï¼Œæˆ‘å€‘ä¸æ‡‰æŠŠå®ƒåˆºç ´ï¼Œä»¥å…å— _______ æ„ŸæŸ“ã€‚", options: ["ç´…è…« / ç—…æ¯’", "æ°´æ³¡ / ç´°èŒ", "ç˜€å‚· / ç°å¡µ", "çš®å¤–å‚· / é¢¨å¯’"], correct: 1, explanation: "æ°´æ³¡æ˜¯ä¿è­·å±¤ï¼Œåˆºç ´å®¹æ˜“å¼•è‡´ç´°èŒæ„ŸæŸ“ã€‚" },
        { id: 18, type: "fill", page: "ç·´ç¿’å·", instruction: "é¸æ“‡æ­£ç¢ºçš„è©èªå¡«ç©ºï¼š", question: "ç•¶æ„å¤–ç™¼ç”Ÿå¾Œï¼Œç‚ºå‚·è€…é€²è¡Œ _______ èƒ½é˜²æ­¢å‚·å‹¢æˆ–ç—…æƒ…æƒ¡åŒ–ã€‚", options: ["æ‰‹è¡“", "æ€¥æ•‘", "æª¢æŸ¥", "è§€å¯Ÿ"], correct: 1, explanation: "æ€¥æ•‘èƒ½é˜²æ­¢å‚·å‹¢æƒ¡åŒ–ã€‚" },
        { id: 19, type: "fill", page: "ç·´ç¿’å·", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„ç­”æ¡ˆï¼š", question: "ä»¥ä¸‹å“ªäº›æ˜¯æ­£ç¢ºçš„æ€¥æ•‘æ–¹æ³•ï¼Ÿ<br>i. æŠŠæ˜å¥æ‚£è€…çš„é›™è…³æŠ¬é«˜ã€‚<br>ii. æµé¼»è¡€æ™‚ï¼ŒæŠŠé ­å¾®å‘å¾Œå‚¾ã€‚<br>iii. è®“ç†±è¡°ç«­æ‚£è€…å–ä¸‹å†·é¹½æ°´ã€‚", options: ["A. åªæœ‰ i åŠ ii", "B. åªæœ‰ i åŠ iii", "C. åªæœ‰ ii åŠ iii", "D. ä»¥ä¸Šå…¨éƒ¨çš†æ˜¯"], correct: 1, explanation: "æ˜å¥æ‡‰æŠ¬é«˜é›™è…³ï¼›ç†±è¡°ç«­æ‡‰è£œå……é¹½æ°´ã€‚æµé¼»è¡€é ­æ‡‰å‰å‚¾ã€‚" },
        { id: 20, type: "fill", page: "ç·´ç¿’å·", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„ç­”æ¡ˆï¼š", question: "ç•¶æˆ‘å€‘çœ‹åˆ°äº¤é€šæ„å¤–æ™‚ï¼Œæ‡‰è©²æ€æ¨£è™•ç†ï¼Ÿ", options: ["A. æ¼ ä¸é—œå¿ƒ", "B. ä¸Šå‰åœè§€", "C. é¦¬ä¸ŠæŠŠå‚·è€…ç§»å‹•è‡³é™°æ¶¼è™•", "D. å…ˆç¢ºä¿è‡ªå·±çš„å®‰å…¨å†æä¾›å”åŠ©"], correct: 3, explanation: "æ€¥æ•‘é¦–è¦åŸå‰‡æ˜¯ç¢ºä¿è‡ªèº«å®‰å…¨ã€‚" },
        { id: 21, type: "text_input", page: "ç·´ç¿’å·", instruction: "å›ç­”å•é¡Œï¼š", question: "ç‚ºç”šéº¼æœ‰äººæ˜å¥æ™‚ï¼Œæˆ‘å€‘è¦è«‹åœè§€çš„äººè®“é–‹ï¼Ÿ", correct: "ä¿æŒç©ºæ°£æµé€š", explanation: "ç¢ºä¿ç©ºæ°£æµé€šï¼Œè®“æ‚£è€…æœ‰è¶³å¤ æ–°é®®ç©ºæ°£ã€‚" },
        { id: 22, type: "fill", page: "ç·´ç¿’å·", instruction: "å›ç­”å•é¡Œï¼š", question: "å°è‡´æµé¼»è¡€çš„å…¶ä¸­ä¸€å€‹åŸå› æ˜¯ç”šéº¼ï¼Ÿ", options: ["é¼»è†œä¹¾ç‡¥ / é¼»éƒ¨å—æ’æ“Š", "å–å¤ªå¤šæ°´", "ç¡çœ å……è¶³", "é‹å‹•é©é‡"], correct: 0, explanation: "å¸¸è¦‹åŸå› ï¼šé¼»è†œä¹¾ç‡¥ã€å—æ’æ“Šã€æŒ–é¼»å­”ç­‰ã€‚" },
        { id: 23, type: "text_input", page: "ç·´ç¿’å·", instruction: "å›ç­”å•é¡Œï¼š", question: "æŠŠæ˜å¥æ‚£è€…çš„è…¿éƒ¨ç•¥ç‚ºæŠ¬é«˜ï¼Œå¯ä»¥ä»¤è¡€æ¶²æµå‘å“ªè£ï¼Ÿ", correct: "è…¦éƒ¨", explanation: "æŠ¬é«˜é›™è…³æœ‰åŠ©è¡€æ¶²å›æµè‡³è…¦éƒ¨ã€‚" },
        { id: 24, type: "fill", page: "ç·´ç¿’å·", instruction: "å›ç­”å•é¡Œï¼š", question: "ç‚ºç”šéº¼éƒŠéŠæ™‚ä¸æ‡‰é£Ÿç”¨é‡è‡æˆ–é‡æœï¼Ÿ", options: ["å®¹æ˜“æœ‰æ¯’", "å‘³é“ä¸å¥½", "æœªç¶“æ¸…æ´—", "ç ´å£ç’°å¢ƒ"], correct: 0, explanation: "é‡å¤–è‡é¡æœå¯¦å¸¸æœ‰åŠ‡æ¯’ï¼Œèª¤é£Ÿå¯è‡´æ­»ã€‚" },
        { id: 25, type: "tf", page: "ç·´ç¿’å·", instruction: "åˆ¤æ–·å¥å­æè¿°æ˜¯å¦æ­£ç¢ºï¼š", question: "æ¶ˆé˜²å“¡çš„è·è²¬åªæ˜¯æ’²æ»…ç«è­¦ã€‚", options: ["æ­£ç¢º âœ”ï¸", "ä¸æ­£ç¢º âŒ"], correct: 1, explanation: "ä¸æ­£ç¢ºã€‚æ¶ˆé˜²å“¡é‚„è² è²¬æ•‘æ´ã€è™•ç†å±éšªå“åŠæä¾›å…ˆé£æ€¥æ•‘ç­‰ã€‚" },
        { id: 26, type: "tf", page: "ç·´ç¿’å·", instruction: "åˆ¤æ–·å¥å­æè¿°æ˜¯å¦æ­£ç¢ºï¼š", question: "æˆ‘å€‘å—å‚·å¾Œï¼Œå‚·å£æœƒçµç—‚ï¼Œé€™æ¨£å¯ä»¥é˜²æ­¢å‚·å£ç¹¼çºŒå‡ºè¡€ï¼Œä¸¦ä¿è­·å‚·å£å…å—æ„ŸæŸ“ã€‚", options: ["æ­£ç¢º âœ”ï¸", "ä¸æ­£ç¢º âŒ"], correct: 0, explanation: "æ­£ç¢ºã€‚çµç—‚æœ‰åŠ©æ­¢è¡€åŠé˜²æ­¢æ„ŸæŸ“ã€‚" },
        {
            id: 27, type: "case_study", page: "ç·´ç¿’å·", instruction: "é‡åˆ°ä»¥ä¸‹æƒ…æ³æ™‚ï¼Œæˆ‘å€‘æ˜¯å¦éœ€è¦å¬å–šæ•‘è­·è»Šï¼Ÿ", img: "img/case_ambulance.jpg",
            subQuestions: [
                { qid: "2-1", text: "1. éœ€è¦å¬å–šæ•‘è­·è»Šçš„æƒ…æ³ï¼š(è«‹å¡«å¯«å­—æ¯ï¼Œå¦‚ A, B)", type: "text_input", correct: "A, B, D", altCorrect: ["A,B,D", "A B D", "ABD"], correctText: "A, B, D" },
                { qid: "2-2", text: "2. ä¸éœ€è¦å¬å–šæ•‘è­·è»Šçš„æƒ…æ³ï¼š(è«‹å¡«å¯«å­—æ¯)", type: "text_input", correct: "C", correctText: "C" }
            ], explanation: "å±æ€¥æƒ…æ³(å¦‚çª’æ¯ã€æ˜è¿·ã€å¿ƒè‡Ÿç—…ç™¼)éœ€å«æ•‘è­·è»Šï¼›è¼•å¾®æ“¦å‚·å‰‡ä¸ç”¨ã€‚"
        },
        // --- Modified Multi-select Question ---
        {
            id: 28, 
            type: "mc_multi", // Changed from 'fill'
            page: "ç·´ç¿’å·",
            instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„ç­”æ¡ˆï¼š(å¯é¸å¤šé …)",
            question: "ä»¥ä¸‹å“ªäº›æ˜¯å°è‡´æ˜å¥çš„åŸå› ï¼Ÿ",
            options: ["A. ä½è¡€ç³–", "B. éåº¦ç–²å‹", "C. æ²’æœ‰é©æ™‚è£œå……æ°´åˆ†", "D. åœ¨æ‚¶ç†±çš„åœ°æ–¹é•·æ™‚é–“ç«™ç«‹"],
            correct: [0, 1, 3], // A, B, D
            explanation: "å¸¸è¦‹å°è‡´æ˜å¥çš„åŸå› åŒ…æ‹¬ï¼šä½è¡€ç³–ã€éåº¦ç–²å‹åŠåœ¨æ‚¶ç†±åœ°æ–¹é•·æ™‚é–“ç«™ç«‹(å¼•è‡´è¡€å£“ä¸‹é™)ã€‚<br>ã€Œæ²’æœ‰é©æ™‚è£œå……æ°´åˆ†ã€ä¸»è¦å¼•è‡´ç†±è¡°ç«­ï¼Œé›–ç„¶åš´é‡ä¹Ÿæœƒæšˆå€’ï¼Œä½†å‰ä¸‰è€…æ›´ç›´æ¥è¢«æ­¸é¡ç‚ºæ˜å¥æˆå› ã€‚"
        },
        // ------------------------------------
        { id: 29, type: "fill", page: "ç·´ç¿’å·", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„ç­”æ¡ˆï¼š", question: "æ»…ç«ç­’é€šå¸¸å¯ç”¨ä¾†æ’²æ»…å°ç«ã€‚å¦‚æœå®¶ä¸­æœ‰é›»å™¨çŸ­è·¯èµ·ç«ï¼Œæˆ‘å€‘ä¸å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å“ªç¨®æ»…ç«ç­’ä¾†æ»…ç«ï¼Ÿ", options: ["ä¹¾ç²‰å¼æ»…ç«ç­’", "æ°´å¼æ»…ç«ç­’", "äºŒæ°§åŒ–ç¢³æ°£é«”å¼æ»…ç«ç­’"], correct: 1, explanation: "æ°´å¼æ»…ç«ç­’æœƒå°é›»ï¼Œæœ‰è§¸é›»å±éšªã€‚" },
        { id: 30, type: "fill", page: "ç·´ç¿’å·", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„ç­”æ¡ˆï¼š", question: "æ„›æ»‹ç—…ç”±äººé¡å…ç–«åŠ›ç¼ºä¹ç—…æ¯’ (HIV) å¼•è‡´ã€‚ä»¥ä¸‹å“ªé …ä¸æ˜¯æ„ŸæŸ“ HIV çš„é€”å¾‘ï¼Ÿ", options: ["è¼¸è¡€", "æ€§æ¥è§¸", "åŒæ¡Œç”¨é¤"], correct: 2, explanation: "ç¤¾äº¤æ¥è§¸ï¼ˆå¦‚åŒæ¡Œç”¨é¤ï¼‰ä¸æœƒå‚³æ’­ HIVã€‚" },
        { id: 31, type: "fill", page: "ç·´ç¿’å·", instruction: "è«‹é¸æ“‡æ­£ç¢ºçš„ç­”æ¡ˆï¼š", question: "é¦™æ¸¯å±…æ°‘åˆ°å…¬ç«‹é†«é™¢æ€¥ç—‡å®¤æ±‚è¨ºçš„æ”¶è²»æ˜¯æ¯æ¬¡æ¸¯å¹£å¤šå°‘å…ƒï¼Ÿ(ä»¥èª²æœ¬ç‚ºæº–)", options: ["100 å…ƒ", "180 å…ƒ", "200 å…ƒ"], correct: 1, explanation: "ç¾æ™‚æ”¶è²»ç‚º $180ã€‚" },
        { id: 32, type: "text_input", page: "ç·´ç¿’å·", instruction: "å¯«å‡ºå…©å€‹é¦™æ¸¯å¿—é¡˜æ•‘æ´æ©Ÿæ§‹ï¼š(è«‹ç”¨é “è™Ÿåˆ†éš”)", question: "å¯«å‡ºå…©å€‹é¦™æ¸¯å¿—é¡˜æ•‘æ´æ©Ÿæ§‹ã€‚", correct: "é¦™æ¸¯è–ç´„ç¿°æ•‘å‚·éšŠã€é†«ç™‚è¼”åŠ©éšŠ", altCorrect: ["è–ç´„ç¿°æ•‘å‚·éšŠã€é†«ç™‚è¼”åŠ©éšŠ", "é†«ç™‚è¼”åŠ©éšŠã€é¦™æ¸¯è–ç´„ç¿°æ•‘å‚·éšŠ", "æ°‘çœ¾å®‰å…¨æœå‹™éšŠã€é†«ç™‚è¼”åŠ©éšŠ"], explanation: "å¸¸è¦‹ï¼šè–ç´„ç¿°æ•‘å‚·éšŠã€é†«ç™‚è¼”åŠ©éšŠã€æ°‘çœ¾å®‰å…¨æœå‹™éšŠã€‚" },
        { id: 33, type: "text_input", page: "ç·´ç¿’å·", instruction: "å¯«å‡ºå…©é …å¯ç”¨ä½œæ¸…æ´—å‚·å£çš„ç”¨å“ï¼š(è«‹ç”¨é “è™Ÿåˆ†éš”)", question: "å¯«å‡ºå…©é …å¯ç”¨ä½œæ¸…æ´—å‚·å£çš„ç”¨å“ã€‚", correct: "ç”Ÿç†é¹½æ°´ã€æ¶ˆæ¯’è—¥æ°´", altCorrect: ["ç”Ÿç†é¹½æ°´ã€è’¸é¤¾æ°´", "æ¶ˆæ¯’è—¥æ°´ã€æ¸…æ°´"], explanation: "ç”Ÿç†é¹½æ°´ã€æ¶ˆæ¯’è—¥æ°´æˆ–è’¸é¤¾æ°´å‡å¯ã€‚" }
    ];

    let currentState = { questionIndex: 0, correctCount: 0, incorrectCount: 0, selectedOption: null, sequenceAnswer: [], multiSelection: [], inputValue: "", subAnswers: {}, isChecking: false, userHistory: [], answeredMap: {} };
    const dom = { progressBar: document.getElementById('progress-bar'), questionArea: document.getElementById('question-area'), checkBtn: document.getElementById('check-btn'), trackers: { question: document.getElementById('question-tracker'), score: document.getElementById('score-tracker') }, feedback: { overlay: document.getElementById('feedback-overlay'), title: document.getElementById('feedback-title'), message: document.getElementById('feedback-message') }, screens: { quiz: document.getElementById('quiz-screen'), end: document.getElementById('end-screen'), header: document.getElementById('header-banner'), status: document.getElementById('status-bar') }, reviewList: document.getElementById('review-list'), navGrid: document.getElementById('nav-grid') };

    function init() { renderNavGrid(); renderQuestion(); updateHeaderUI(); }
    function renderNavGrid() { dom.navGrid.innerHTML = ''; questions.forEach((q, idx) => { const btn = document.createElement('div'); btn.className = 'nav-btn'; btn.innerText = idx + 1; btn.id = `nav-btn-${idx}`; btn.onclick = () => jumpToQuestion(idx); if (currentState.answeredMap[idx] === 'correct') btn.classList.add('correct'); else if (currentState.answeredMap[idx] === 'wrong') btn.classList.add('wrong'); if (idx === currentState.questionIndex) btn.classList.add('active'); dom.navGrid.appendChild(btn); }); }
    function jumpToQuestion(idx) { if (currentState.isChecking) return; currentState.questionIndex = idx; renderQuestion(); updateHeaderUI(); updateNavHighlight(); }
    function updateNavHighlight() { document.querySelectorAll('.nav-btn').forEach((btn, idx) => { if (idx === currentState.questionIndex) btn.classList.add('active'); else btn.classList.remove('active'); }); }
    function updateNavStatus(idx, isCorrect) { const btn = document.getElementById(`nav-btn-${idx}`); currentState.answeredMap[idx] = isCorrect ? 'correct' : 'wrong'; btn.classList.remove('correct', 'wrong'); btn.classList.add(isCorrect ? 'correct' : 'wrong'); }
    function updateHeaderUI() { const pct = ((Object.keys(currentState.answeredMap).length) / questions.length) * 100; dom.progressBar.style.width = pct + '%'; dom.trackers.question.innerText = `é¡Œç›® ${currentState.questionIndex + 1}/${questions.length}`; dom.trackers.score.innerText = `æ­£ç¢º: ${currentState.correctCount} | ä¸æ­£ç¢º: ${currentState.incorrectCount}`; }

    function renderQuestion() {
        const q = questions[currentState.questionIndex];
        const area = dom.questionArea;
        const isAnswered = currentState.answeredMap.hasOwnProperty(currentState.questionIndex);
        
        currentState.selectedOption = null;
        currentState.sequenceAnswer = [];
        currentState.multiSelection = [];
        currentState.inputValue = "";
        currentState.subAnswers = {}; 
        currentState.isChecking = isAnswered; 
        
        dom.checkBtn.innerText = isAnswered ? "ä¸‹ä¸€é¡Œ" : "æª¢æŸ¥";
        dom.checkBtn.disabled = !isAnswered; 
        if (isAnswered) { dom.checkBtn.onclick = nextQuestion; } else { dom.checkBtn.onclick = checkAnswer; }

        let html = `
            <div class="mascot-container"><div class="mascot"></div><div class="speech-bubble">${q.instruction}</div></div>
            <div class="question-header-row">${q.type !== 'case_study' ? `<h1 class="question-text">${q.question.replace('_______', '<span style="color:#1cb0f6; border-bottom:2px solid #1cb0f6; padding:0 5px;">_______</span>')}</h1>` : ''}<span class="page-badge">${q.page}</span></div>
        `;

        if (q.type === 'case_study') html += renderCaseStudyMode(q);
        else if (q.type === 'sequence') html += renderSequenceMode(q);
        else if (q.type === 'text_input') html += renderInputMode(q);
        else if (q.type === 'tf') html += renderTFMode(q);
        else if (q.type === 'mc_image_grid') html += renderImageGridMode(q);
        else if (q.type === 'mc_multi') html += renderStandardMode(q, true); // New Mode
        else html += renderStandardMode(q);

        area.innerHTML = html;
        
        if (isAnswered) {
             const inputs = area.querySelectorAll('input, .option-card, .word-bubble');
             inputs.forEach(el => el.style.pointerEvents = 'none');
             area.style.opacity = '0.6';
             let msgDiv = document.createElement('div');
             msgDiv.innerHTML = '<div style="text-align:center; padding:10px; color:var(--duo-blue); font-weight:bold;">æ­¤é¡Œå·²ä½œç­”</div>';
             area.insertBefore(msgDiv, area.firstChild);
        }

        if(!isAnswered) {
            if(q.type === 'sequence') setupSequenceListeners(q);
            if(q.type === 'text_input') setupInputListeners();
        }
    }

    function renderStandardMode(q, isMulti = false) {
        let optsHtml = '<div class="options-grid">';
        q.options.forEach((opt, idx) => { 
            let clickFn = isMulti ? `handleMultiSelect(${idx}, this)` : `handleOptionSelect(${idx}, this)`;
            optsHtml += `<div class="option-card" onclick="${clickFn}">${opt}</div>`; 
        });
        return optsHtml + '</div>';
    }

    // ... (Keep renderCaseStudyMode, renderTFMode, renderImageGridMode, renderSequenceMode, renderInputMode from previous logic) ...
    function renderCaseStudyMode(q) { let subQHtml = ''; q.subQuestions.forEach((sub, idx) => { let controlHtml = ''; if(sub.type === 'fill' || sub.type === 'mc') { controlHtml = `<div class="options-grid" style="grid-template-columns:1fr;">`; sub.options.forEach((opt, optIdx) => { controlHtml += `<div class="option-card sub-opt" data-qid="${sub.qid}" data-idx="${optIdx}" onclick="handleSubOptionClick('${sub.qid}', ${optIdx}, this)">${opt}</div>`; }); controlHtml += `</div>`; } else if (sub.type === 'text_input') { controlHtml = `<input type="text" class="input-field sub-input" data-qid="${sub.qid}" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" oninput="handleSubInput('${sub.qid}', this.value)">`; } subQHtml += `<div class="sub-question"><div class="sub-q-label">å•é¡Œ ${idx+1}</div><div class="sub-q-text">${sub.text}</div>${controlHtml}</div>`; }); return `<div class="case-study-container"><div class="case-image-box"><img src="${q.img}" alt="æƒ…å¢ƒåœ–"></div><div class="case-questions-box">${subQHtml}</div></div>`; }
    function renderTFMode(q) { let optsHtml = '<div class="options-grid tf-mode">'; q.options.forEach((opt, idx) => { optsHtml += `<div class="option-card center-text" onclick="handleOptionSelect(${idx}, this)">${opt}</div>`; }); return optsHtml + '</div>'; }
    function renderImageGridMode(q) { let optsHtml = '<div class="options-grid image-mode">'; q.options.forEach((opt, idx) => { optsHtml += `<div class="option-card has-image" onclick="handleOptionSelect(${idx}, this)"><div class="option-image-container"><img src="${opt.img}" onerror="this.style.display='none'"></div><div class="option-label">${opt.label}</div></div>`; }); return optsHtml + '</div>'; }
    function renderSequenceMode(q) { let slotsHtml = '<div class="slots-container" id="sequence-slots"></div>'; let bankHtml = '<div class="word-bank" id="word-bank">'; q.options.forEach((opt, idx) => { bankHtml += `<div class="word-bubble" id="word-${idx}" onclick="handleSequenceClick(${idx})">${opt}</div>`; }); return `<div class="sequence-area">${slotsHtml}${bankHtml}</div>`; }
    function renderInputMode(q) { return `<div class="input-container"><input type="text" id="user-input" class="input-field" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ..." autocomplete="off"></div>`; }

    // --- Interaction Logic ---
    window.handleSubOptionClick = (qid, optIdx, el) => { if(currentState.isChecking) return; el.parentElement.querySelectorAll('.sub-opt').forEach(opt => opt.classList.remove('selected')); el.classList.add('selected'); currentState.subAnswers[qid] = optIdx; checkCaseStudyCompletion(); };
    window.handleSubInput = (qid, val) => { if(currentState.isChecking) return; currentState.subAnswers[qid] = val.trim(); checkCaseStudyCompletion(); };
    function checkCaseStudyCompletion() { const q = questions[currentState.questionIndex]; dom.checkBtn.disabled = !q.subQuestions.every(s => currentState.subAnswers[s.qid] !== undefined && currentState.subAnswers[s.qid] !== ""); }
    window.handleOptionSelect = (idx, el) => { if (currentState.isChecking) return; document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); currentState.selectedOption = idx; dom.checkBtn.disabled = false; };
    
    // New: Multi Select Logic
    window.handleMultiSelect = (idx, el) => {
        if (currentState.isChecking) return;
        el.classList.toggle('selected');
        const indexInArr = currentState.multiSelection.indexOf(idx);
        if (indexInArr > -1) currentState.multiSelection.splice(indexInArr, 1);
        else currentState.multiSelection.push(idx);
        dom.checkBtn.disabled = currentState.multiSelection.length === 0;
    };

    window.handleSequenceClick = (optIdx) => { if (currentState.isChecking) return; const currentAnswer = currentState.sequenceAnswer; const existingIndex = currentAnswer.indexOf(optIdx); if (existingIndex === -1) currentAnswer.push(optIdx); else currentAnswer.splice(existingIndex, 1); updateSequenceUI(questions[currentState.questionIndex]); };
    function updateSequenceUI(q) { const slotsContainer = document.getElementById('sequence-slots'); const bankContainer = document.getElementById('word-bank'); slotsContainer.innerHTML = ''; bankContainer.innerHTML = ''; currentState.sequenceAnswer.forEach(optIdx => { const el = document.createElement('div'); el.className = 'word-bubble in-slot'; el.innerText = q.options[optIdx]; el.onclick = () => handleSequenceClick(optIdx); slotsContainer.appendChild(el); }); q.options.forEach((optText, idx) => { const el = document.createElement('div'); if (currentState.sequenceAnswer.includes(idx)) { el.className = 'word-bubble placeholder'; el.innerText = optText; } else { el.className = 'word-bubble'; el.innerText = optText; el.onclick = () => handleSequenceClick(idx); } bankContainer.appendChild(el); }); dom.checkBtn.disabled = currentState.sequenceAnswer.length !== q.options.length; }
    function setupInputListeners() { const input = document.getElementById('user-input'); input.addEventListener('input', (e) => { currentState.inputValue = e.target.value.trim(); dom.checkBtn.disabled = currentState.inputValue.length === 0; }); input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && currentState.inputValue.length > 0) checkAnswer(); }); }

    // --- Check Answer ---
    window.checkAnswer = () => {
        currentState.isChecking = true;
        const q = questions[currentState.questionIndex];
        let isCorrect = false;
        let userAnsRecord = "", correctAnsRecord = "";

        if (q.type === 'case_study') {
            let allSubCorrect = true; let details = [];
            q.subQuestions.forEach((sub, idx) => {
                const userAns = currentState.subAnswers[sub.qid]; let subCorrect = false;
                if (sub.type === 'text_input') { const valid = Array.isArray(sub.altCorrect) ? [...sub.altCorrect, sub.correct] : [sub.correct]; subCorrect = valid.some(v => userAns.includes(v) || v.includes(userAns)); } 
                else { subCorrect = (userAns === sub.correct); }
                if(!subCorrect) allSubCorrect = false; details.push(`${idx+1}. ${sub.correctText || sub.correct}`);
            });
            isCorrect = allSubCorrect; userAnsRecord = isCorrect ? "å…¨éƒ¨æ­£ç¢º" : "éƒ¨åˆ†éŒ¯èª¤"; correctAnsRecord = details.join(" | ");
        } else if (q.type === 'mc_multi') {
            // Check arrays: user's selection vs correct array (order doesn't matter)
            const userSet = new Set(currentState.multiSelection.map(String));
            const correctSet = new Set(q.correct.map(String));
            isCorrect = (userSet.size === correctSet.size) && [...userSet].every(x => correctSet.has(x));
            
            userAnsRecord = currentState.multiSelection.map(i => q.options[i]).join(", ");
            correctAnsRecord = q.correct.map(i => q.options[i]).join(", ");
            
            // Visual feedback for multi
            document.querySelectorAll('.option-card').forEach((el, idx) => {
                const isSelected = el.classList.contains('selected');
                const isActuallyCorrect = q.correct.includes(idx);
                if (isSelected && isActuallyCorrect) el.classList.add('correct');
                else if (isSelected && !isActuallyCorrect) el.classList.add('wrong');
                else if (!isSelected && isActuallyCorrect) el.classList.add('missed'); // Show missed correct answers
            });

        } else if (q.type === 'sequence') {
            isCorrect = JSON.stringify(currentState.sequenceAnswer) === JSON.stringify(q.correct);
            userAnsRecord = currentState.sequenceAnswer.map(i => q.options[i]).join("â†’"); correctAnsRecord = q.correct.map(i => q.options[i]).join("â†’");
        } else if (q.type === 'text_input') {
            const valid = Array.isArray(q.altCorrect) ? [...q.altCorrect, q.correct] : [q.correct];
            isCorrect = valid.some(v => currentState.inputValue.includes(v) || v.includes(currentState.inputValue));
            userAnsRecord = currentState.inputValue; correctAnsRecord = q.correct;
        } else {
            isCorrect = currentState.selectedOption === q.correct;
            userAnsRecord = q.options[currentState.selectedOption] ? (q.options[currentState.selectedOption].label || q.options[currentState.selectedOption]) : "æœªä½œç­”";
            correctAnsRecord = q.options[q.correct].label || q.options[q.correct];
        }

        currentState.userHistory.push({ qIndex: currentState.questionIndex, isCorrect, userAns: userAnsRecord, correctAns: correctAnsRecord });
        updateNavStatus(currentState.questionIndex, isCorrect);

        if (isCorrect) { currentState.correctCount++; showFeedback(true, q.explanation ? `å¤ªæ£’äº†ï¼<br>${q.explanation}` : "æ­£ç¢ºï¼"); } 
        else { currentState.incorrectCount++; let msg = q.explanation || "è«‹å†æ¥å†å²ï¼"; if(q.type === 'text_input' || q.type === 'sequence') msg = `æ­£ç¢ºç­”æ¡ˆï¼š${correctAnsRecord}<br>${msg}`; showFeedback(false, msg); }
        
        dom.checkBtn.innerText = "ä¸‹ä¸€é¡Œ"; dom.checkBtn.onclick = nextQuestion; updateHeaderUI();
    };

    function showFeedback(isCorrect, msg) { const fb = dom.feedback; fb.overlay.classList.remove('correct', 'wrong'); fb.overlay.classList.add(isCorrect ? 'correct' : 'wrong'); fb.overlay.classList.add('show'); fb.title.innerText = isCorrect ? 'âœ… æ­£ç¢ºï¼' : 'âŒ éŒ¯èª¤'; fb.message.innerHTML = msg; }
    window.nextQuestion = () => { dom.feedback.overlay.classList.remove('show'); let nextIdx = currentState.questionIndex + 1; if (nextIdx < questions.length) { currentState.questionIndex = nextIdx; setTimeout(() => { renderQuestion(); updateHeaderUI(); updateNavHighlight(); }, 300); } else { if (Object.keys(currentState.answeredMap).length === questions.length) { showEndScreen(); } else { alert("ä½ å·²åˆ°é”æœ€å¾Œä¸€é¡Œï¼Œè«‹ä½¿ç”¨ä¸Šæ–¹å°èˆªåˆ—æª¢æŸ¥æœªå®Œæˆçš„é¡Œç›®ã€‚"); showEndScreen(); } } };
    function showEndScreen() { dom.screens.quiz.style.display = 'none'; dom.screens.status.style.display = 'none'; dom.navGrid.style.display = 'none'; dom.screens.end.style.display = 'flex'; document.getElementById('final-correct').innerText = currentState.correctCount; document.getElementById('final-incorrect').innerText = currentState.incorrectCount; renderReviewList(); }
    function renderReviewList() { const list = dom.reviewList; list.innerHTML = ""; currentState.userHistory.sort((a,b) => a.qIndex - b.qIndex); currentState.userHistory.forEach((record) => { const q = questions[record.qIndex]; const item = document.createElement('div'); item.className = `review-item ${record.isCorrect ? 'correct' : 'wrong'}`; let statusIcon = record.isCorrect ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'; let qText = q.type === 'case_study' ? 'ç¶œåˆèƒ½åŠ›è¨“ç·´ (æƒ…å¢ƒé¡Œ)' : q.question; let html = `<div class="review-header"><span>é¡Œç›® ${record.qIndex + 1}</span><span>${statusIcon}</span></div><div class="review-q">${qText}</div><div class="review-feedback">`; if (!record.isCorrect) html += `<span class="review-ans-label">æ‚¨çš„ç­”æ¡ˆï¼š</span><div class="ans-wrong">${record.userAns}</div><div style="height:10px"></div>`; html += `<span class="review-ans-label">æ­£ç¢ºç­”æ¡ˆï¼š</span><div class="ans-correct">${record.correctAns}</div></div>`; item.innerHTML = html; list.appendChild(item); }); }

    init();
</script>
</body>
</html>
